<!doctype html><html lang=en><head><title>Mocking in Python</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.c27cd4e332ca297fb25625ebfb0fd08824b3344ee00869c5bc395be617ba225b.css integrity="sha256-wnzU4zLKKX+yViXr+w/QiCSzNE7gCGnFvDlb5he6Ils="><link rel=icon type=image/png href=/images/author/image_al_hu6aa485cfd64a98f54b411e3a0324b396_178285_42x0_resize_q75_box.jpg><meta property="og:title" content="Mocking in Python"><meta property="og:description" content="Topics: Mocking in Python
Today, I want to talk about mocking. I became interested in this topic a few months back when I started to work in a data engineering project at work. In this project we have a lot of tests that relies on mocking to test code with external dependencies. If you don&rsquo;t like reading long blog posts, consider listening to one of the podcast episodes I did on this topic: there is one at Talk Python to Me and the other at Test and Code."><meta property="og:type" content="article"><meta property="og:url" content="https://alpopkes.com/posts/python/mocking/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-10-11T00:00:00+00:00"><meta property="article:modified_time" content="2020-10-11T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Mocking in Python"><meta name=twitter:description content="Topics: Mocking in Python
Today, I want to talk about mocking. I became interested in this topic a few months back when I started to work in a data engineering project at work. In this project we have a lot of tests that relies on mocking to test code with external dependencies. If you don&rsquo;t like reading long blog posts, consider listening to one of the podcast episodes I did on this topic: there is one at Talk Python to Me and the other at Test and Code."><meta name=description content="Mocking in Python"><script>theme=localStorage.getItem("darkmode:color-scheme")||"system",theme=="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/><img src=/images/author/image_al_hu6aa485cfd64a98f54b411e3a0324b396_178285_42x0_resize_q75_box.jpg id=logo alt=Logo>
Anna-Lena Popkes</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-toggle=collapse data-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/#home>Home</a></li><li class=nav-item><a class=nav-link href=/#about>About</a></li><li class=nav-item><a class=nav-link href=/#skills>Skills</a></li><li class=nav-item><a class=nav-link href=/#experiences>Experiences</a></li><li class=nav-item><a class=nav-link href=/#education>Education</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>More</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=/#education>Education</a>
<a class=dropdown-item href=/#recent-posts>Recent Posts</a>
<a class=dropdown-item href=/#appearances>Talks & Podcasts</a></div></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/posts>Posts</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/author/image_al_hu6aa485cfd64a98f54b411e3a0324b396_178285_42x0_resize_q75_box.jpg class=d-none id=main-logo alt=Logo>
<img src=/images/author/image_al_hu6aa485cfd64a98f54b411e3a0324b396_178285_42x0_resize_q75_box.jpg class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts/ data-filter=all>Posts</a></li><div class=subtree><li><a class=list-link href=/posts/news/ title="Personal news">Personal news</a></li><li><a class=list-link href=/posts/my_path_to_ml/ title="My path to machine learning">My path to machine learning</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/books/> Books</a><ul><li><a class=list-link href=/posts/books/reading_list/ title="Personal reading List">Personal reading List</a></li><li><a class=list-link href=/posts/books/deep_work/ title="Deep work">Deep work</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/machine_learning/> Machine Learning</a><ul><li><a class=list-link href=/posts/machine_learning/bayesian_linear_regression/ title="Bayesian linear regression">Bayesian linear regression</a></li><li><a class=list-link href=/posts/machine_learning/bayesian_linear_regression_2/ title="Bayesian linear regression 2">Bayesian linear regression 2</a></li><li><a class=list-link href=/posts/machine_learning/kl_divergence/ title="KL Divergence">KL Divergence</a></li><li><a class=list-link href=/posts/machine_learning/principal_component_analysis/ title="Principal component analysis (PCA)">Principal component analysis (PCA)</a></li><li><a class=list-link href=/posts/machine_learning/support_vector_machines/ title="Support vector machines">Support vector machines</a></li><li><a class=list-link href=/posts/machine_learning/variational_inference/ title="Variational Inference">Variational Inference</a></li></ul></li><li><i data-feather=minus-circle></i><a class="active list-link" href=/posts/python/> Python</a><ul class=active><li><a class="active list-link" href=/posts/python/mocking/ title=Mocking>Mocking</a></li><li><a class=list-link href=/posts/python/packaging_tools/ title="Packaging tools">Packaging tools</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/python/magical_universe/> Magical Universe</a><ul><li><a class=list-link href=/posts/python/magical_universe/day_1_start/ title=Start>Start</a></li><li><a class=list-link href=/posts/python/magical_universe/day_1_magical_universe/ title="The Tales of Castle Kilmere">The Tales of Castle Kilmere</a></li><li><a class=list-link href=/posts/python/magical_universe/day_1_first_post_oop/ title="Object-oriented programming">Object-oriented programming</a></li><li><a class=list-link href=/posts/python/magical_universe/day_2_types_of_methods/ title="Types of methods">Types of methods</a></li><li><a class=list-link href=/posts/python/magical_universe/day_3_type_annotations/ title="Type annotations">Type annotations</a></li><li><a class=list-link href=/posts/python/magical_universe/day_4_to_string_conversion/ title="To-string conversion">To-string conversion</a></li><li><a class=list-link href=/posts/python/magical_universe/day_5_decorators/ title=Decorators>Decorators</a></li><li><a class=list-link href=/posts/python/magical_universe/day_6_properties/ title=Properties>Properties</a></li><li><a class=list-link href=/posts/python/magical_universe/day_7_underscore_patterns/ title="Underscore patterns">Underscore patterns</a></li><li><a class=list-link href=/posts/python/magical_universe/day_8_extending_universe/ title="Extending the universe">Extending the universe</a></li><li><a class=list-link href=/posts/python/magical_universe/day_9_duck_typing/ title="Duck Typing">Duck Typing</a></li><li><a class=list-link href=/posts/python/magical_universe/day_10_11_namedtuples/ title=Namedtuples>Namedtuples</a></li><li><a class=list-link href=/posts/python/magical_universe/day_12_to_15_abcs/ title="Abstract Base Classes">Abstract Base Classes</a></li><li><a class=list-link href=/posts/python/magical_universe/day_16_to_18_data_classes/ title="Data classes">Data classes</a></li><li><a class=list-link href=/posts/python/magical_universe/day_19_immutable_data_classes/ title="Immutable data classes">Immutable data classes</a></li><li><a class=list-link href=/posts/python/magical_universe/day_20_decorators_in_classes/ title="Decorators in classes">Decorators in classes</a></li><li><a class=list-link href=/posts/python/magical_universe/day_21_if_main/ title='if __name__ == "__main__"'>if __name__ == "__main__"</a></li><li><a class=list-link href=/posts/python/magical_universe/day_22_to_24_context_managers/ title="Context managers">Context managers</a></li><li><a class=list-link href=/posts/python/magical_universe/day_25_to_28_pytest/ title="Testing with pytest">Testing with pytest</a></li><li><a class=list-link href=/posts/python/magical_universe/day_29_to_31_iterators/ title=Iterators>Iterators</a></li><li><a class=list-link href=/posts/python/magical_universe/day_34_multisets/ title=Multisets>Multisets</a></li><li><a class=list-link href=/posts/python/magical_universe/day_37_extending_universe/ title="Extending the universe II">Extending the universe II</a></li><li><a class=list-link href=/posts/python/magical_universe/day_43_to_45_exception_classes/ title="Exception classes">Exception classes</a></li><li><a class=list-link href=/posts/python/magical_universe/day_46_functools_wraps/ title=functools.wraps>functools.wraps</a></li><li><a class=list-link href=/posts/python/magical_universe/day_47_to_48_defaultdict/ title=Defaultdict>Defaultdict</a></li><li><a class=list-link href=/posts/python/magical_universe/day_49_to_50_config_files/ title="Config files">Config files</a></li><li><a class=list-link href=/posts/python/magical_universe/2018-09-16-blog-post-day-51/ title="Wrap up">Wrap up</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/software_engineering/> Software Engineering</a><ul><li><a class=list-link href=/posts/software_engineering/containers/ title="Intro to containers">Intro to containers</a></li><li><a class=list-link href=/posts/software_engineering/docker/ title="Intro to Docker">Intro to Docker</a></li><li><a class=list-link href=/posts/software_engineering/virtual_machines/ title="Intro to virtual machines">Intro to virtual machines</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/image_al_hu6aa485cfd64a98f54b411e3a0324b396_178285_120x120_fit_q75_box.jpg alt="Author Image"><h5 class=author-name>Anna-Lena Popkes</h5><p class=text-muted>Sunday, October 11, 2020</p></div><div class=title><h1>Mocking in Python</h1></div><div class=post-content id=post-content><p><strong>Topics:</strong> Mocking in Python</p><p>Today, I want to talk about mocking. I became interested in this topic a few months back when I started to work in a data engineering project at work. In this project we have a lot of tests that relies on mocking to test code with external dependencies. If you don&rsquo;t like reading long blog posts, consider listening to one of the podcast episodes I did on this topic: there is one at <a href>Talk Python to Me</a> and the other at <a href>Test and Code</a>.</p><h2 id=introduction>Introduction</h2><p>Before getting started you should note that mocking is a controversial topic. Some people think it is great while others regard it only as a last resort that should be be avoided. Personally, I believe that mocking can be a great tool to improve testing but should be used with care. Most importantly, it should not be used as a tool to fix badly written code. However, the Zen of Python tells us that practicality beats purity. So rather use mocking than no testing at all.</p><h2 id=what-is-mocking>What is mocking?</h2><p>A mock simulates the existence and behavior of a real object. This allows developers to</p><ul><li>Improve the quality of their tests</li><li>Test code in a controlled environment</li><li>Test code which has external dependencies</li><li>&mldr;</li></ul><p>The python library for mocking is <code>unittest.mock</code>. If you prefer using <code>pytest</code>, don&rsquo;t worry - <code>pytest</code> supports the <code>unittest.mock</code> library. You can also take a look at pytest libraries for mocking like <a href=https://pypi.org/project/pytest-mock/ target=_blank rel=noopener>pytest-mock</a>.</p><h2 id=example-class>Example class</h2><p>In the spirit of our magical universe <a href=http://alpopkes.com/posts/2018/07/the_tales_of_castle_kilmere/ target=_blank rel=noopener>The Tales of Castle Kilmere</a> we will work with an example class <code>Spell</code> in this blog post. Our <code>Spell</code> class is simple: each spell has a name, an incantation and a defining feature:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Spell</span>:
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;&#34;&#34;Creates a spell&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>def</span> __init__(self, name: str, incantation: str, defining_feature: str):
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>incantation <span style=color:#f92672>=</span> incantation
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>defining_feature <span style=color:#f92672>=</span> defining_feature
</span></span></code></pre></div><h2 id=naming-conventions-and-test-doubles>Naming conventions and Test Doubles</h2><p>Similar to the question of whether mocking is good or bad there is disagreement about the terminology of mocking. Some people prefer a more fine-grained terminology in which different types of &lsquo;mocking behavior&rsquo; are distinguished. Others believe that this makes things unnecessarily complicated. For completeness, let’s take a look at the more fine-grained view. In this view, objects which are not real can be either dummies, fakes, stubs, mocks or spies. All of these are so called <em>test-doubles</em>. Note that the definitions of the different kinds of test doubles are not set in stone but are controversial and vary between sources.</p><h3 id=dummies>Dummies</h3><p>A dummy is an object which is passed around but not intended to be used in your tests. It will have no effect on the behaviour of your tests. An example for a dummy could be an attribute that is needed in order to instantiate a class but not required for the test. Looking at our <code>Spell</code> class we might want to test casting a spell but won&rsquo;t require the <code>defining_feature</code> attribute for this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Spell</span>:
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;&#34;&#34;Creates a spell&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>def</span> __init__(self, name: str, incantation: str, defining_feature: str):
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>incantation <span style=color:#f92672>=</span> incantation
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>defining_feature <span style=color:#f92672>=</span> defining_feature
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>cast</span>(self):
</span></span><span style=display:flex><span>      print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>incantation<span style=color:#e6db74>}</span><span style=color:#e6db74>!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_cast_spell</span>():
</span></span><span style=display:flex><span>   name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;The Stuporus Ratiato spell&#34;</span>
</span></span><span style=display:flex><span>   incantation <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Stuporus Ratiato&#34;</span>
</span></span><span style=display:flex><span>   defining_feature <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#75715e># this is a dummy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>assert</span> spell<span style=color:#f92672>.</span>cast <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Stuporus Ratiatio!&#34;</span>
</span></span></code></pre></div><h3 id=fakes>Fakes</h3><p>A fake implements a fake version of a class or method. It has a working implementation but takes some kind of shortcut such that it is not suitable for production. For example, we could implement an in memory database which is used for testing but not in production. In this setting, the in memory database would function as a fake.</p><h3 id=stubs>Stubs</h3><p>A stub is a non-real object which has pre-programmed behavior. Most of the time, stubs simply return fixed values (also refered to as canned data). For example, let’s say the <code>Spell</code> class has a method <code>get_similar_spells</code> which searches a database for similar spells. The logic behind this function is very complex and the function takes several minutes to complete. During testing, we don&rsquo;t want to wait several minutes for a result. Therefore, we could replace the real implementation with a stub that returns hard-coded values; taking only a small fraction of the time.</p><h3 id=mocks>Mocks</h3><p>Mocks are closely related to stubs. A mock does not have predetermined behavior. Instead, it has to be configured with our expectations. The important difference between mocks and stubs is that a mock records which calls have been executed. Therefore, it can be used to verify not only the result (which can be done with a stub, too) but HOW the result was achieved / that the correct methods have been invoked. Mocks are the type of test double we will be talking about in this blog post.</p><p>If you are confused about the difference between stubs and mocks, that a look at <a href=https://stackoverflow.com/questions/3459287/whats-the-difference-between-a-mock-stub target=_blank rel=noopener>this stackoverflow post</a>. It might be helpful.</p><h3 id=spies>Spies</h3><p>Spies are used to wrap real objects and, by default, route all method calls to the original object. In this sense, they intercept and record all calls to a real object. This allows us to verify calls to the original object (e.g. how often a certain method has been called) without replacing the original object (as, for example, a mock does). I haven’t use spies myself yet and find them the hardest to understand.</p><h2 id=when-should-we-mock>When should we mock?</h2><p>Mocking can be used whenever we don&rsquo;t want to actually call an object. Let&rsquo;s say our <code>Spell</code> class has a function <code>save</code> which writes file to disk and function <code>remove</code> which deletes local file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Spell</span>:
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;&#34;&#34;Creates a spell&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>def</span> __init__(self, name: str, incantation: str, defining_feature: str):
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>incantation <span style=color:#f92672>=</span> incantation
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>defining_feature <span style=color:#f92672>=</span> defining_feature
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>save</span>(self, save_path: str) <span style=color:#f92672>-&gt;</span> dict:
</span></span><span style=display:flex><span>      spell_as_dict <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;name&#34;</span>: self<span style=color:#f92672>.</span>name,
</span></span><span style=display:flex><span>	               <span style=color:#e6db74>&#34;incantation&#34;</span>: self<span style=color:#f92672>.</span>incantation,
</span></span><span style=display:flex><span>	               <span style=color:#e6db74>&#34;description&#34;</span>: self<span style=color:#f92672>.</span>description}
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>with</span> open(save_path, <span style=color:#e6db74>&#34;w&#34;</span>) <span style=color:#66d9ef>as</span> file:
</span></span><span style=display:flex><span>         json<span style=color:#f92672>.</span>dump(spell_as_dict, file, indent<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> spell_as_dict
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>remove</span>(self, file_path: str):
</span></span><span style=display:flex><span>      os<span style=color:#f92672>.</span>remove(file_path)
</span></span></code></pre></div><p>When testing these methods we don’t want to write to disk every time the test runs
Same holds for function ‘remove’</p><h2 id=how-to-mock>How to mock</h2><p>The <code>unittest.mock</code> library has three core functionalities:</p><ol><li>The <code>Mock</code> class</li><li>The <code>MagicMock</code> class</li><li>The <code>patch</code> method</li></ol><h3 id=the-unittestmockmock-class>The <code>unittest.mock.Mock</code> class</h3><p>The <code>Mock</code> class can be used for mocking any object. A mock simulates the object it replaces. To achieve this, it creates attributes on the fly. In other words: you can access whatever methods and attributes you like, the mock object will simply create them. This is quite magical, don&rsquo;t you think?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> unittest.mock <span style=color:#f92672>import</span> Mock
</span></span><span style=display:flex><span>my_mock <span style=color:#f92672>=</span> Mock()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Let&#39;s try to access some attribute</span>
</span></span><span style=display:flex><span>my_mock<span style=color:#f92672>.</span>fancy_attribute
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>&lt;</span>Mock name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;mock.fancy_attribute&#39;</span> id<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;140586483377056&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># What about a method with inputs?</span>
</span></span><span style=display:flex><span>my_mock<span style=color:#f92672>.</span>fancy_method(<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>&lt;</span>Mock name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;mock.fancy_method()&#39;</span> id<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;140586482172880&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># We can assert that certain methods can be called</span>
</span></span><span style=display:flex><span>my_mock<span style=color:#f92672>.</span>fancy_method<span style=color:#f92672>.</span>assert_called_with(<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#66d9ef>True</span>
</span></span></code></pre></div><p>When taking a close look at the example above we can see that each call returns a mock object with a different ID. This is an important feature of mocks: they will automatically create child mocks when you access a property or method. You should keep in mind that the methods and attributes you create have nothing to do with the &rsquo;true&rsquo; implementation of a method. For example, we could mock the <code>json</code> library and access the method <code>dumps</code> on the mock object. We could call <code>dumps</code> with all kinds of attributes (or non at all) without the mock complaining about it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>json <span style=color:#f92672>=</span> Mock()
</span></span><span style=display:flex><span>json<span style=color:#f92672>.</span>dumps()
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>&lt;</span>Mock name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;mock.dumps()&#39;</span> id<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;140586482201840&#39;</span><span style=color:#f92672>&gt;</span> 
</span></span><span style=display:flex><span>json<span style=color:#f92672>.</span>dumps<span style=color:#f92672>.</span>assert_called_once()
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#66d9ef>True</span>
</span></span></code></pre></div><p>We can configue a mock object to do exactly what we want it to do. For instance, we can set the
return value of a mock, or side effects it should exhibit:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>my_mock <span style=color:#f92672>=</span> Mock()
</span></span><span style=display:flex><span>my_mock<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>my_mock()
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>my_mock <span style=color:#f92672>=</span> Mock(side_effect<span style=color:#f92672>=</span><span style=color:#a6e22e>Exception</span>(<span style=color:#e6db74>&#34;Python rocks!&#34;</span>))
</span></span><span style=display:flex><span>my_mock()
</span></span><span style=display:flex><span><span style=color:#f92672>---------------------------------------------------------------------------</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Exception</span>                                 Traceback (most recent call last)
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>ipython<span style=color:#f92672>-</span>input<span style=color:#f92672>-</span><span style=color:#ae81ff>14</span><span style=color:#f92672>-</span>faa07e9a9283<span style=color:#f92672>&gt;</span> <span style=color:#f92672>in</span> <span style=color:#f92672>&lt;</span>module<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>----&gt;</span> <span style=color:#ae81ff>1</span> my_mock()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>~/</span>anaconda3<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>python3<span style=color:#ae81ff>.8</span><span style=color:#f92672>/</span>unittest<span style=color:#f92672>/</span>mock<span style=color:#f92672>.</span>py <span style=color:#f92672>in</span> __call__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>1079</span>         self<span style=color:#f92672>.</span>_mock_check_sig(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>1080</span>         self<span style=color:#f92672>.</span>_increment_mock_call(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span><span style=color:#f92672>-&gt;</span> <span style=color:#ae81ff>1081</span>         <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_mock_call(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>1082</span> 
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>1083</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>~/</span>anaconda3<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>python3<span style=color:#ae81ff>.8</span><span style=color:#f92672>/</span>unittest<span style=color:#f92672>/</span>mock<span style=color:#f92672>.</span>py <span style=color:#f92672>in</span> _mock_call(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>1083</span> 
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>1084</span>     <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_mock_call</span>(self, <span style=color:#f92672>/</span>, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span><span style=color:#f92672>-&gt;</span> <span style=color:#ae81ff>1085</span>         <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_execute_mock_call(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>1086</span> 
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>1087</span>     <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_increment_mock_call</span>(self, <span style=color:#f92672>/</span>, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>~/</span>anaconda3<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>python3<span style=color:#ae81ff>.8</span><span style=color:#f92672>/</span>unittest<span style=color:#f92672>/</span>mock<span style=color:#f92672>.</span>py <span style=color:#f92672>in</span> _execute_mock_call(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>1138</span>         <span style=color:#66d9ef>if</span> effect <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>1139</span>             <span style=color:#66d9ef>if</span> _is_exception(effect):
</span></span><span style=display:flex><span><span style=color:#f92672>-&gt;</span> <span style=color:#ae81ff>1140</span>                 <span style=color:#66d9ef>raise</span> effect
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>1141</span>             <span style=color:#66d9ef>elif</span> <span style=color:#f92672>not</span> _callable(effect):
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>1142</span>                 result <span style=color:#f92672>=</span> next(effect)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Exception</span>: Python rocks<span style=color:#960050;background-color:#1e0010>!</span>
</span></span></code></pre></div><h3 id=mock-vs-magicmock><code>Mock</code> vs. <code>MagicMock</code></h3><p>I mentioned that the <code>unittest.mock</code> library contains two classes: <code>Mock</code> and <code>MagicMock</code>. So what is the difference between them? <code>MagicMock</code> is a subclass of <code>Mock</code>. It contains all magic methods pre-created and ready to use (e.g. <code>__str__</code>, <code>__len__</code>, etc.). Therefore, you should use <code>MagicMock</code> when you need magic methods, and <code>Mock</code> if you don&rsquo;t need them.</p><h3 id=the-unittestmockpatch-method>The <code>unittest.mock.patch</code> method</h3><p>The third main functionality contained in the <code>unittest.mock</code> library is the <code>patch</code> function. So what is patching? The <code>patch()</code> function looks up an object in a given module and replaces it with another object. By default, the object is replaced with a new <code>MagicMock</code> (but this can be changed). When you want to use <code>patch</code> you have to use the syntax <code>patch(‘package.module.target’)</code>. For example, consider we have a file <code>example.py</code> which contains the following code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> db <span style=color:#f92672>import</span> db_write
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>foo</span>():
</span></span><span style=display:flex><span>   x <span style=color:#f92672>=</span> db_write()
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> x
</span></span></code></pre></div><p>We want to mock the call to the <code>db_write</code> function in our tests. With patching, this can be dones as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> unittest.mock <span style=color:#f92672>import</span> patch
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> example <span style=color:#f92672>import</span> foo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@patch</span>(<span style=color:#e6db74>&#39;example.db_write&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_foo</span>(mock_write):
</span></span><span style=display:flex><span>   mock_write<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>   x <span style=color:#f92672>=</span> foo()
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>assert</span> x <span style=color:#f92672>==</span> <span style=color:#ae81ff>10</span>
</span></span></code></pre></div><p>What is happening when using patching like this? In simple terms, the call to <code>db_write</code> is replaced with a call to <code>MagicMock</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>foo</span>():
</span></span><span style=display:flex><span>   x <span style=color:#f92672>=</span> MagicMock()
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> x
</span></span></code></pre></div><p>By replacing the call to <code>db_write</code> with a call to <code>MagicMock</code>, everything happening in <code>db_write</code> is not being executed. The only thing that is called is the <code>MagicMock</code> object!</p><p>In the example above we used <code>patch()</code> as a decorator. We could also use it as a context manager or with manual starting/stopping. When to use which version depends on the <em>scope</em> you want/need. Consider the decorator example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> unittest.mock <span style=color:#f92672>import</span> patch
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> example <span style=color:#f92672>import</span> foo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@patch</span>(<span style=color:#e6db74>&#39;example.db_write&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_foo_decorator</span>(mock_write):
</span></span><span style=display:flex><span>   mock_write<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>   x <span style=color:#f92672>=</span> foo()
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>assert</span> x <span style=color:#f92672>==</span> <span style=color:#ae81ff>10</span>
</span></span></code></pre></div><p>In this example, the <code>db_write</code> function will be replaced by a <code>MagicMock</code> for the entire test
function. In other words: in the test function <code>test_foo_decorator</code> you don&rsquo;t have access to the true implementation of <code>db_write</code> anymore, only to the mocked version. A more fine-grained scheme can be achieved using a context manager:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_foo_context_manager</span>(mock_write):
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>with</span> patch(<span style=color:#e6db74>&#39;example.db_write`, return_value = 10):</span>
</span></span><span style=display:flex><span>      x1 <span style=color:#f92672>=</span> foo()
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>assert</span> x1 <span style=color:#f92672>==</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   x2 <span style=color:#f92672>=</span> foo() <span style=color:#75715e># When calling foo here, db_write won&#39;t be mocked</span>
</span></span></code></pre></div><p>Manual starting and stopping can be useful when you need to mock certain parts of your code for all tests in your test file. I haven&rsquo;t yet used this functionality myself but you can find a good description <a href=https://docs.python.org/3/library/unittest.mock.html target=_blank rel=noopener>here</a>.</p><p>Note: there is also <code>patch.object</code> and <code>patch.dict</code>. We won’t discuss them here to avoid confusion, please check out the <a href=https://docs.python.org/3/library/unittest.mock.html target=_blank rel=noopener>documentation</a> to find out how they are used.</p><h2 id=where-do-we-patch>Where do we patch?</h2><p>When using patching it is important to know <em>where</em> <code>patch</code> is applied. Specifically, we should patch where the object is <em>looked up</em>. This might not be the place where the object is defined! In the example above (the one where our file is named <code>example.py</code>) we import the method <code>db_write</code> from the module <code>db</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> db <span style=color:#f92672>import</span> db_write
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>foo</span>():
</span></span><span style=display:flex><span>   x <span style=color:#f92672>=</span> db_write()
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> x
</span></span></code></pre></div><p>Consequently, the <code>example</code> module knows about <code>db_write</code>. However, it does <strong>not</strong> know about <code>db</code>. This is nicely illustrated when importing the <code>example</code> module (e.g. in an IPython shell) and calling <code>dir(example)</code> to see a list of attributes for the <code>example</code> object.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> example
</span></span><span style=display:flex><span>dir(example)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span><span style=display:flex><span>[<span style=color:#e6db74>&#39;__builtins__&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;__cached__&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;__doc__&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;__file__&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;__loader__&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;__name__&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;__package__&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;__spec__&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;db_write&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;foo&#39;</span>]
</span></span></code></pre></div><p>As we can see here, <code>db_write</code> is in the namespace of <code>example</code>, but <code>db</code> is <strong>not</strong> in the
namespace. Therefore, to mock the call to <code>db_write</code> in the <code>foo</code> function, we have to patch
<code>example.db_write</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> unittest.mock <span style=color:#f92672>import</span> patch
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> example <span style=color:#f92672>import</span> foo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@patch</span>(<span style=color:#e6db74>&#39;example.db_write&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_foo_decorator</span>(mock_write):
</span></span><span style=display:flex><span>   mock_write<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>   x <span style=color:#f92672>=</span> foo()
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>assert</span> x <span style=color:#f92672>==</span> <span style=color:#ae81ff>10</span>
</span></span></code></pre></div><p>Think about this for a moment - <code>db_write</code> is <em>defined</em> in the module <code>db</code> but <em>used</em> in the module <code>example</code>.</p><p>Let&rsquo;s drive this point home with another example. Let&rsquo;s say that we import the entire <code>db</code> module in <code>example.py</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> db
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>foo</span>():
</span></span><span style=display:flex><span>   x <span style=color:#f92672>=</span> db<span style=color:#f92672>.</span>db_write()
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> x
</span></span></code></pre></div><p>In this case, the <code>example</code> module knows about <code>db</code> but <strong>not</strong> <code>db_write</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> example
</span></span><span style=display:flex><span>dir(example)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span><span style=display:flex><span>[<span style=color:#e6db74>&#39;__builtins__&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;__cached__&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;__doc__&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;__file__&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;__loader__&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;__name__&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;__package__&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;__spec__&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;db&#39;</span>,
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;foo&#39;</span>]
</span></span></code></pre></div><p>To mock the call to <code>db_write</code> in the <code>foo</code> function, we need to mock <code>db.db_write</code> or, if you find it easier to understand <code>example.db.db_write</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> unittest.mock <span style=color:#f92672>import</span> patch
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> example <span style=color:#f92672>import</span> foo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@patch</span>(<span style=color:#e6db74>&#39;example.db.db_write&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_foo_decorator</span>(mock_write):
</span></span><span style=display:flex><span>   mock_write<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>   x <span style=color:#f92672>=</span> foo()
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>assert</span> x <span style=color:#f92672>==</span> <span style=color:#ae81ff>10</span>
</span></span></code></pre></div><h2 id=common-mocking-problems-and-how-to-solve-them>Common mocking problems and how to solve them</h2><p>In the beginning of this post we saw that we can configure <code>Mock</code> objects. For example, we can set their return value or side effects like exceptions. The fact that <code>Mock</code> objects create attributes and methods on the fly makes them sensitive to mistakes. For example, if you call <code>.asert_called_once()</code> instead of <code>.assert_called_once()</code> on a Mock, the test will not raise an <code>AssertionError</code> because you have created a new method on the Mock object called <code>asert_called_once()</code> instead of calling the actual function.</p><p>Another easy mistake occurs when forgetting that a Mock object does not know the interface of your class / method. In other words: the Mock object does not know which attributes it can be called with. We talked about that earlier with the <code>json.dumps()</code> example. We can illustrate this problem when taking a closer look at the attributes of the thing we are mocking. Let&rsquo;s say we we mock our <code>Spell</code> class. When calling <code>dir()</code> on the mocked object we see all kinds of attributes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> spell_class
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> unittest.mock <span style=color:#f92672>import</span> patch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> patch(<span style=color:#e6db74>&#39;spell_class.Spell&#39;</span>) <span style=color:#66d9ef>as</span> mocked_spell:
</span></span><span style=display:flex><span>   print(dir(mocked_spell))
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span><span style=display:flex><span>[<span style=color:#e6db74>&#39;assert_any_call&#39;</span>, <span style=color:#e6db74>&#39;assert_called&#39;</span>, <span style=color:#e6db74>&#39;assert_called_once&#39;</span>, <span style=color:#e6db74>&#39;assert_called_once_with&#39;</span>, <span style=color:#e6db74>&#39;assert_called_with&#39;</span>, <span style=color:#e6db74>&#39;assert_has_calls&#39;</span>, <span style=color:#e6db74>&#39;assert_not_called&#39;</span>, <span style=color:#e6db74>&#39;attach_mock&#39;</span>, <span style=color:#e6db74>&#39;call_args&#39;</span>, <span style=color:#e6db74>&#39;call_args_list&#39;</span>, <span style=color:#e6db74>&#39;call_count&#39;</span>, <span style=color:#e6db74>&#39;called&#39;</span>, <span style=color:#e6db74>&#39;configure_mock&#39;</span>, <span style=color:#e6db74>&#39;method_calls&#39;</span>, <span style=color:#e6db74>&#39;mock_add_spec&#39;</span>, <span style=color:#e6db74>&#39;mock_calls&#39;</span>, <span style=color:#e6db74>&#39;reset_mock&#39;</span>, <span style=color:#e6db74>&#39;return_value&#39;</span>, <span style=color:#e6db74>&#39;side_effect&#39;</span>]
</span></span></code></pre></div><p>For example, we can see the different assertions that can be made on the Mock object. Hover, we don’t see the actual methods of the <code>Spell</code> class, e.g. the <code>save</code> or <code>remove</code> method! This is because the call to <code>patch</code> returns a <code>MagicMock</code> which is completely unrelated to the <code>Spell</code> class.</p><p>Problems like these can be solved using the <code>spec=True</code> attribute in the <code>patch</code> call. This will cause the <code>MagicMock</code> to look like the object we are patching. We could no longer call methods without argument or with the wrong arguments. Also, the misspelled <code>.asert_called_once()</code> would raise an Exception:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> spell_class
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> unittest.mock <span style=color:#f92672>import</span> patch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> patch(<span style=color:#e6db74>&#39;spell_class.Spell&#39;</span>, spec<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>) <span style=color:#66d9ef>as</span> mocked_spell:
</span></span><span style=display:flex><span>   print(dir(mocked_spell))
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> [<span style=color:#e6db74>&#39;__class__&#39;</span>, <span style=color:#e6db74>&#39;__delattr__&#39;</span>, <span style=color:#e6db74>&#39;__dict__&#39;</span>, <span style=color:#e6db74>&#39;__dir__&#39;</span>, <span style=color:#e6db74>&#39;__doc__&#39;</span>, <span style=color:#e6db74>&#39;__eq__&#39;</span>, <span style=color:#e6db74>&#39;__format__&#39;</span>, <span style=color:#e6db74>&#39;__ge__&#39;</span>, <span style=color:#e6db74>&#39;__getattribute__&#39;</span>, <span style=color:#e6db74>&#39;__gt__&#39;</span>, <span style=color:#e6db74>&#39;__hash__&#39;</span>, <span style=color:#e6db74>&#39;__init__&#39;</span>, <span style=color:#e6db74>&#39;__init_subclass__&#39;</span>, <span style=color:#e6db74>&#39;__le__&#39;</span>, <span style=color:#e6db74>&#39;__lt__&#39;</span>, <span style=color:#e6db74>&#39;__module__&#39;</span>, <span style=color:#e6db74>&#39;__ne__&#39;</span>, <span style=color:#e6db74>&#39;__new__&#39;</span>, <span style=color:#e6db74>&#39;__reduce__&#39;</span>, <span style=color:#e6db74>&#39;__reduce_ex__&#39;</span>, <span style=color:#e6db74>&#39;__repr__&#39;</span>, <span style=color:#e6db74>&#39;__setattr__&#39;</span>, <span style=color:#e6db74>&#39;__sizeof__&#39;</span>, <span style=color:#e6db74>&#39;__str__&#39;</span>, <span style=color:#e6db74>&#39;__subclasshook__&#39;</span>, <span style=color:#e6db74>&#39;__weakref__&#39;</span>, <span style=color:#e6db74>&#39;assert_any_call&#39;</span>, <span style=color:#e6db74>&#39;assert_called&#39;</span>, <span style=color:#e6db74>&#39;assert_called_once&#39;</span>, <span style=color:#e6db74>&#39;assert_called_once_with&#39;</span>, <span style=color:#e6db74>&#39;assert_called_with&#39;</span>, <span style=color:#e6db74>&#39;assert_has_calls&#39;</span>, <span style=color:#e6db74>&#39;assert_not_called&#39;</span>, <span style=color:#e6db74>&#39;attach_mock&#39;</span>, <span style=color:#e6db74>&#39;call_args&#39;</span>, <span style=color:#e6db74>&#39;call_args_list&#39;</span>, <span style=color:#e6db74>&#39;call_count&#39;</span>, <span style=color:#e6db74>&#39;called&#39;</span>, <span style=color:#e6db74>&#39;configure_mock&#39;</span>, <span style=color:#e6db74>&#39;method_calls&#39;</span>, <span style=color:#e6db74>&#39;mock_add_spec&#39;</span>, <span style=color:#e6db74>&#39;mock_calls&#39;</span>, <span style=color:#e6db74>&#39;remove&#39;</span>, <span style=color:#e6db74>&#39;reset_mock&#39;</span>, <span style=color:#e6db74>&#39;return_value&#39;</span>, <span style=color:#e6db74>&#39;save&#39;</span>, <span style=color:#e6db74>&#39;side_effect&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> patch(<span style=color:#e6db74>&#39;spell_class.Spell&#39;</span>, spec<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>) <span style=color:#66d9ef>as</span> mocked_spell:
</span></span><span style=display:flex><span>   mocked_spell<span style=color:#f92672>.</span>asert_called_once()
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>---------------------------------------------------------------------------</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AttributeError</span>                            Traceback (most recent call last)
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>ipython<span style=color:#f92672>-</span>input<span style=color:#f92672>-</span><span style=color:#ae81ff>3</span><span style=color:#f92672>-</span>d3058c55a4ad<span style=color:#f92672>&gt;</span> <span style=color:#f92672>in</span> <span style=color:#f92672>&lt;</span>module<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>3</span> 
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>4</span> <span style=color:#66d9ef>with</span> patch(<span style=color:#e6db74>&#39;spell_class.Spell&#39;</span>, spec<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>) <span style=color:#66d9ef>as</span> mocked_spell:
</span></span><span style=display:flex><span><span style=color:#f92672>----&gt;</span> <span style=color:#ae81ff>5</span>    mocked_spell<span style=color:#f92672>.</span>asert_called_once()
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>6</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>~/</span>anaconda3<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>python3<span style=color:#ae81ff>.8</span><span style=color:#f92672>/</span>unittest<span style=color:#f92672>/</span>mock<span style=color:#f92672>.</span>py <span style=color:#f92672>in</span> __getattr__(self, name)
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>635</span>         <span style=color:#66d9ef>elif</span> self<span style=color:#f92672>.</span>_mock_methods <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>636</span>             <span style=color:#66d9ef>if</span> name <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>_mock_methods <span style=color:#f92672>or</span> name <span style=color:#f92672>in</span> _all_magics:
</span></span><span style=display:flex><span><span style=color:#f92672>--&gt;</span> <span style=color:#ae81ff>637</span>                 <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>AttributeError</span>(<span style=color:#e6db74>&#34;Mock object has no attribute </span><span style=color:#e6db74>%r</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> name)
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>638</span>         <span style=color:#66d9ef>elif</span> _is_magic(name):
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>639</span>             <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>AttributeError</span>(name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AttributeError</span>: Mock object has no attribute <span style=color:#e6db74>&#39;asert_called_once&#39;</span>
</span></span></code></pre></div><p>Similar to <code>spec</code> are <code>autospec</code> and <code>specset</code>. Take a look at the <a href=https://docs.python.org/3/library/unittest.mock.html target=_blank rel=noopener>documentation</a> or at the PyCon talk <a href="https://www.youtube.com/watch?v=ww1UsGZV8fQ" target=_blank rel=noopener>“Demystifying the patch function”</a> for more details.</p><p>One caveat when using <code>spec</code> (or <code>autospec</code> or <code>specset</code>) is that you can <em>not</em> access attributes created in the <code>__init__</code> method, that is, attributes that exist on the instances and not the class. Due to the internal workings of <code>spec</code> (and also <code>autospec</code> and <code>specset</code>) they cannot know about any dynamically created attributes. They only know about visible attributes. For our <code>Spell</code> example above, you won&rsquo;t see the attributes <code>name</code>, <code>incantation</code> and <code>description</code> in the output of <code>dir(mocked_spell)</code>. They are not valid attributes of the mock object anymore. Also, speccing comes at a cost and will slow down your tests</p><h2 id=code-design-that-prevents-mocking>Code design that prevents mocking</h2><p>When you stumble into <em>mock hell</em> (a term introduced and explained in the talk <a href="https://www.youtube.com/watch?v=Ldlz4V-UCFw" target=_blank rel=noopener>&ldquo;Mocking and Patching Pitfalls&rdquo;</a>) during development, it might be the right time to consider one of the design principles that prevent the need for mocking. For example, you could use dependency injection or an adaptor pattern. These principles are explained in the PyCon talk <a href="https://www.youtube.com/watch?v=rk-f3B-eMkI" target=_blank rel=noopener>&ldquo;Stop using Mocks - For a While&rdquo;</a>.</p><h2 id=wrap-up>Wrap-Up</h2><p>Mocking is a controversial topic. It should be used with care and never to fix badly written code. The Python library for mocking - <code>unittest.mock</code> - comes with three core functionalities: <code>Mock, MagicMock</code> and <code>patch</code>. Mocking might seem confusing in the beginning but once you understand the basics (for example where to patch) it can be very helpful, especially with production code. There are lots of functionalities in the <code>unittest.mock</code> library that help prevent common problems, so it is useful to take a look at the documentation when you want to start using mocking. Lastly, don’t get confused by the different naming conventions! If you feel more comfortable with the fine-grained view on test doubles great! But sticking to a simpler scheme is also fine.</p></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/zotroneneis/zotroneneis.github.io/edit/main/content/posts/python/mocking.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/machine_learning/variational_inference/ title="Variational Inference" class="btn filled-button"><div><i class="fas fa-chevron-circle-left"></i> Prev</div><div class=next-prev-text>Variational Inference</div></a></div><div class="col-md-6 next-article"><a href=/posts/python/packaging_tools/ title="An unbiased evaluation of environment management and packaging tools" class="btn filled-button"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>An unbiased evaluation of environment management and packaging tools</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn data-toggle=tooltip data-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#what-is-mocking>What is mocking?</a></li><li><a href=#example-class>Example class</a></li><li><a href=#naming-conventions-and-test-doubles>Naming conventions and Test Doubles</a><ul><li><a href=#dummies>Dummies</a></li><li><a href=#fakes>Fakes</a></li><li><a href=#stubs>Stubs</a></li><li><a href=#mocks>Mocks</a></li><li><a href=#spies>Spies</a></li></ul></li><li><a href=#when-should-we-mock>When should we mock?</a></li><li><a href=#how-to-mock>How to mock</a><ul><li><a href=#the-unittestmockmock-class>The <code>unittest.mock.Mock</code> class</a></li><li><a href=#mock-vs-magicmock><code>Mock</code> vs. <code>MagicMock</code></a></li><li><a href=#the-unittestmockpatch-method>The <code>unittest.mock.patch</code> method</a></li></ul></li><li><a href=#where-do-we-patch>Where do we patch?</a></li><li><a href=#common-mocking-problems-and-how-to-solve-them>Common mocking problems and how to solve them</a></li><li><a href=#code-design-that-prevents-mocking>Code design that prevents mocking</a></li><li><a href=#wrap-up>Wrap-Up</a></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://alpopkes.com#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://alpopkes.com#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://alpopkes.com#experiences>Experiences</a></li><li class=nav-item><a class=smooth-scroll href=https://alpopkes.com#education>Education</a></li><li class=nav-item><a class=smooth-scroll href=https://alpopkes.com#projects>Projects</a></li><li class=nav-item><a class=smooth-scroll href=https://alpopkes.com#recent-posts>Recent Posts</a></li><li class=nav-item><a class=smooth-scroll href=https://alpopkes.com#appearances>Talks & Podcasts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:popkes@gmx.net target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>popkes@gmx.net</span></a></li></ul></div><div class="col-md-4 col-sm-12"><p>Stay up to date with email notification</p><form method=post action=https://blogtrottr.com><div class=form-group><input type=email class=form-control name=btr_email placeholder="Enter email"><br><input type=hidden name=btr_url value=https://alpopkes.com/index.xml>
<input type=hidden name=schedule_type value=1>
<small id=emailHelp class="form-text text-muted">We'll never share your email with anyone else.</small>
<button type=submit class="btn btn-info"> Submit</button></div></form></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2020-2021 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.a01d837827c5183eb1439ce1afe5db5896d8b892671bcbe43996542de67b6510.js integrity="sha256-oB2DeCfFGD6xQ5zhr+XbWJbYuJJnG8vkOZZULeZ7ZRA=" defer></script></body></html>